// RSendMail GUI - Material Design 3
// Copyright (c) 2024 RSendMail Authors

// Material Components
import {
    FilledButton,
    TextButton,
    TonalButton,
    OutlinedCard,
    FilledCard,
    ElevatedCard,
    TextField,
    Switch,
    CheckBox,
    LinearProgressIndicator,
    ScrollView,
    MaterialPalette,
    MaterialStyleMetrics,
    MaterialTypography,
    MaterialText,
    SegmentedButton,
    ListTile,
} from "@material";

// Standard widgets (for components not in Material library)
import { ComboBox, Palette, Button, LineEdit } from "std-widgets.slint";

// Embed full CJK font for complete Chinese character support
import "../fonts/NotoSansSC-Full.otf";

// ===== App Theme State =====
export global AppTheme {
    in-out property <bool> dark-mode: false;
}

// ===== Send Status Enum =====
export enum SendStatus {
    Idle,
    Preparing,
    Sending,
    Stopped,
    Completed
}

// ===== Send Mode Enum =====
export enum SendMode {
    EmlBatch,
    SingleAttachment,
    DirAttachment
}

// ===== Log Entry Struct =====
export struct LogEntry {
    timestamp: string,
    level: string,
    message: string,
}

// ===== Stat Card Component =====
component StatCard inherits Rectangle {
    in property <string> label: "";
    in property <string> value: "0";
    in property <color> accent-color: MaterialPalette.primary;

    background: MaterialPalette.surface_container_low;
    border-radius: 12px;
    border-width: 1px;
    border-color: MaterialPalette.outline_variant;

    VerticalLayout {
        padding: 12px;
        spacing: 4px;
        alignment: center;

        Text {
            text: label;
            font-size: 12px;
            color: MaterialPalette.on_surface_variant;
            horizontal-alignment: center;
        }

        Text {
            text: value;
            font-size: 28px;
            font-weight: 700;
            color: accent-color;
            horizontal-alignment: center;
        }
    }
}

// ===== Log Item Component =====
component LogItem inherits Rectangle {
    in property <string> timestamp: "";
    in property <string> level: "INFO";
    in property <string> message: "";

    property <color> level-color: level == "ERROR" ? MaterialPalette.error :
                                   (level == "WARN" ? #d97706 : MaterialPalette.primary);
    property <color> bg-color: level == "ERROR" ? MaterialPalette.error_container :
                                (level == "WARN" ? #fef3c7 : MaterialPalette.surface_container);

    background: bg-color;
    border-radius: 6px;
    height: 36px;

    HorizontalLayout {
        padding-left: 10px;
        padding-right: 10px;
        spacing: 8px;
        alignment: start;

        Text {
            text: timestamp;
            font-size: 11px;
            color: MaterialPalette.on_surface_variant;
            vertical-alignment: center;
            width: 60px;
        }

        Rectangle {
            width: 48px;
            height: 20px;
            border-radius: 4px;
            background: level-color;

            Text {
                text: level;
                font-size: 10px;
                font-weight: 600;
                color: white;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        Text {
            text: message;
            font-size: 12px;
            color: MaterialPalette.on_surface;
            overflow: elide;
            horizontal-stretch: 1;
            vertical-alignment: center;
        }
    }
}

// ===== Section Header Component =====
component SectionHeader inherits Rectangle {
    in property <string> title: "";

    height: 32px;

    HorizontalLayout {
        padding-left: 4px;
        alignment: start;

        Text {
            text: title;
            font-size: 14px;
            font-weight: 600;
            color: MaterialPalette.primary;
            vertical-alignment: center;
        }
    }
}

// ===== Switch Row Component =====
component SwitchRow inherits HorizontalLayout {
    in property <string> label: "";
    in-out property <bool> checked: false;

    spacing: 8px;
    alignment: start;

    Switch {
        width: 52px;
        height: 32px;
        checked <=> root.checked;
    }

    Text {
        text: label;
        font-size: 13px;
        color: MaterialPalette.on_surface;
        vertical-alignment: center;
    }
}

// ===== Main Application Window =====
export component AppWindow inherits Window {
    init => {
        Palette.color-scheme = AppTheme.dark-mode ? ColorScheme.dark : ColorScheme.light;
    }

    callback toggle-theme();

    title: "RSendMail";
    min-width: 900px;
    min-height: 600px;
    preferred-width: 1200px;
    preferred-height: 800px;
    background: MaterialPalette.surface;
    default-font-family: "Noto Sans CJK SC";

    // ===== i18n Translation Properties =====
    in-out property <string> tr-smtp-server: "SMTP Server";
    in-out property <string> tr-server-address: "Server";
    in-out property <string> tr-port: "Port";
    in-out property <string> tr-use-tls: "TLS";
    in-out property <string> tr-accept-invalid-certs: "Skip Cert";
    in-out property <string> tr-auth-required: "Auth";
    in-out property <string> tr-username: "Username";
    in-out property <string> tr-password: "Password";
    in-out property <string> tr-sender: "From";
    in-out property <string> tr-recipient: "To";
    in-out property <string> tr-recipient-hint: "(comma separated)";

    in-out property <string> tr-send-mode: "Send Mode";
    in-out property <string> tr-eml-batch: "EML Batch";
    in-out property <string> tr-single-attachment: "Attachment";
    in-out property <string> tr-dir-attachment: "Dir Attach";
    in-out property <string> tr-eml-directory: "EML Dir";
    in-out property <string> tr-attachment-file: "File";
    in-out property <string> tr-attachment-directory: "Dir";
    in-out property <string> tr-extension: "Ext";
    in-out property <string> tr-browse: "...";
    in-out property <string> tr-email-subject: "Subject";
    in-out property <string> tr-email-body: "Body";
    in-out property <string> tr-filename-hint: "Use {filename} for filename";

    in-out property <string> tr-advanced-options: "Advanced";
    in-out property <string> tr-performance: "Performance";
    in-out property <string> tr-processes: "Threads";
    in-out property <string> tr-batch-size: "Batch";
    in-out property <string> tr-send-interval: "Interval";
    in-out property <string> tr-timeout: "Timeout";
    in-out property <string> tr-loop-settings: "Loop";
    in-out property <string> tr-infinite-loop: "Loop";
    in-out property <string> tr-repeat-count: "Repeat";
    in-out property <string> tr-loop-interval: "Interval";
    in-out property <string> tr-retry-interval: "Retry";
    in-out property <string> tr-email-processing: "Processing";
    in-out property <string> tr-keep-headers: "Keep Hdr";
    in-out property <string> tr-modify-headers: "Mod Hdr";
    in-out property <string> tr-anonymize-emails: "Anon";
    in-out property <string> tr-domain: "Domain";
    in-out property <string> tr-logging: "Logging";
    in-out property <string> tr-log-level: "Level";
    in-out property <string> tr-log-file: "Log File";
    in-out property <string> tr-failed-emails-dir: "Failed Dir";
    in-out property <string> tr-optional: "(optional)";

    in-out property <string> tr-statistics: "Statistics";
    in-out property <string> tr-total: "Total";
    in-out property <string> tr-success: "Success";
    in-out property <string> tr-failed: "Failed";
    in-out property <string> tr-current-round: "Round";
    in-out property <string> tr-elapsed-time: "Time";

    in-out property <string> tr-send-log: "Log";
    in-out property <string> tr-clear: "Clear";
    in-out property <string> tr-export-log: "Export";

    in-out property <string> tr-save-config: "Save";
    in-out property <string> tr-load-config: "Load";
    in-out property <string> tr-test-connection: "Test";
    in-out property <string> tr-start-send: "Start";
    in-out property <string> tr-stop-send: "Stop";

    in-out property <string> tr-language: "Language";
    in-out property <string> tr-theme: "Theme";
    in-out property <string> tr-ok: "OK";

    // ===== Language Settings =====
    in-out property <[string]> available-languages: [];
    in-out property <int> current-language-index: 0;
    callback language-changed(int);

    // ===== SMTP Configuration =====
    in-out property <string> smtp-server: "";
    in-out property <string> smtp-port-str: "25";
    in-out property <bool> use-tls: false;
    in-out property <bool> accept-invalid-certs: false;
    in-out property <bool> auth-mode: false;
    in-out property <string> username: "";
    in-out property <string> password: "";
    in-out property <string> from-address: "";
    in-out property <string> to-address: "";

    // ===== Send Mode =====
    in-out property <SendMode> send-mode: SendMode.EmlBatch;

    // ===== EML Mode Configuration =====
    in-out property <string> eml-dir: "";
    in-out property <string> eml-extension: "eml";
    in-out property <int> eml-file-count: 0;

    // ===== Attachment Mode Configuration =====
    in-out property <string> attachment-path: "";
    in-out property <string> attachment-dir: "";
    in-out property <int> attachment-file-count: 0;

    // ===== Email Templates =====
    in-out property <string> subject-template: "Attachment: {filename}";
    in-out property <string> text-template: "Please check: {filename}";

    // ===== Advanced Options =====
    in-out property <string> processes: "auto";
    in-out property <string> batch-size-str: "1";
    in-out property <string> smtp-timeout-str: "30";
    in-out property <string> email-interval-str: "0";
    in-out property <bool> loop-mode: false;
    in-out property <string> repeat-count-str: "1";
    in-out property <string> loop-interval-str: "1";
    in-out property <string> retry-interval-str: "5";
    in-out property <bool> keep-headers: false;
    in-out property <bool> modify-headers: false;
    in-out property <bool> anonymize-emails: false;
    in-out property <string> anonymize-domain: "example.com";
    in-out property <string> log-level: "info";
    in-out property <string> log-file: "";
    in-out property <string> failed-emails-dir: "";

    // ===== Send Status =====
    in-out property <SendStatus> status: SendStatus.Idle;
    in-out property <int> total-count: 0;
    in-out property <int> sent-count: 0;
    in-out property <int> success-count: 0;
    in-out property <int> fail-count: 0;
    in-out property <float> qps: 0;
    in-out property <string> elapsed-time: "00:00:00";
    in-out property <int> current-round: 1;
    in-out property <int> total-rounds: 1;
    in-out property <string> status-text: "Ready";

    // ===== Logs =====
    in-out property <[LogEntry]> logs: [];

    // ===== Error/Message Dialog =====
    in-out property <bool> show-message-dialog: false;
    in-out property <string> message-dialog-title: "Message";
    in-out property <string> message-dialog-content: "";
    in-out property <bool> message-dialog-is-error: false;
    callback close-message-dialog();

    // ===== Callbacks =====
    callback test-connection();
    callback start-send();
    callback stop-send();
    callback browse-eml-dir();
    callback browse-attachment();
    callback browse-attachment-dir();
    callback browse-log-file();
    callback browse-failed-dir();
    callback clear-logs();
    callback export-logs();
    callback save-config();
    callback load-config();

    // ===== Main Layout =====
    VerticalLayout {
        padding: 12px;
        spacing: 12px;

        // ===== Top Bar =====
        Rectangle {
            height: 48px;
            background: MaterialPalette.surface_container;
            border-radius: 8px;
            clip: true;

            HorizontalLayout {
                padding-left: 16px;
                padding-right: 16px;
                padding-top: 8px;
                padding-bottom: 8px;
                spacing: 12px;
                alignment: center;

                // Logo
                Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 6px;
                    background: MaterialPalette.primary;

                    Text {
                        text: "‚úâ";
                        font-size: 14px;
                        color: MaterialPalette.on_primary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                Text {
                    text: "RSendMail";
                    font-size: 16px;
                    font-weight: 700;
                    color: MaterialPalette.on_surface;
                    vertical-alignment: center;
                }

                Text {
                    text: "v0.2.0";
                    font-size: 10px;
                    color: MaterialPalette.on_surface_variant;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                // Theme Toggle
                HorizontalLayout {
                    spacing: 6px;
                    alignment: center;

                    Text {
                        text: AppTheme.dark-mode ? "üåô" : "‚òÄ";
                        font-size: 12px;
                        vertical-alignment: center;
                    }

                    Switch {
                        width: 44px;
                        height: 24px;
                        checked: AppTheme.dark-mode;
                        checked-state-changed(checked) => {
                            AppTheme.dark-mode = checked;
                            Palette.color-scheme = checked ? ColorScheme.dark : ColorScheme.light;
                        }
                    }
                }

                // Language
                HorizontalLayout {
                    spacing: 6px;
                    alignment: center;

                    Text {
                        text: "üåê";
                        font-size: 12px;
                        vertical-alignment: center;
                    }

                    ComboBox {
                        model: available-languages;
                        current-index <=> current-language-index;
                        width: 90px;
                        selected(idx) => { language-changed(current-language-index); }
                    }
                }
            }
        }

        // ===== Main Content =====
        HorizontalLayout {
            spacing: 12px;
            vertical-stretch: 1;

            // ===== Left Panel - Configuration =====
            ScrollView {
                width: 48%;

                VerticalLayout {
                    spacing: 12px;
                    padding-right: 8px;

                    // SMTP Server Section
                    OutlinedCard {
                        VerticalLayout {
                            padding: 16px;
                            spacing: 10px;

                            SectionHeader { title: tr-smtp-server; }

                            // Server Address
                            HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: tr-server-address;
                                    width: 60px;
                                    font-size: 13px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> smtp-server;
                                    placeholder-text: "smtp.example.com";
                                    horizontal-stretch: 1;
                                }
                            }

                            // Port
                            HorizontalLayout {
                                spacing: 8px;
                                alignment: start;

                                Text {
                                    text: tr-port;
                                    width: 60px;
                                    font-size: 13px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> smtp-port-str;
                                    width: 60px;
                                }

                                Button { text: "25"; clicked => { smtp-port-str = "25"; } }
                                Button { text: "465"; clicked => { smtp-port-str = "465"; use-tls = true; } }
                                Button { text: "587"; clicked => { smtp-port-str = "587"; } }
                            }

                            // TLS Options
                            HorizontalLayout {
                                spacing: 16px;
                                alignment: start;

                                SwitchRow { label: tr-use-tls; checked <=> use-tls; }
                                SwitchRow { label: tr-accept-invalid-certs; checked <=> accept-invalid-certs; }
                            }

                            // Auth
                            SwitchRow { label: tr-auth-required; checked <=> auth-mode; }

                            if auth-mode: HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: tr-username;
                                    width: 60px;
                                    font-size: 13px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> username;
                                    horizontal-stretch: 1;
                                }

                                Text {
                                    text: tr-password;
                                    width: 60px;
                                    font-size: 13px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> password;
                                    horizontal-stretch: 1;
                                }
                            }

                            // Sender
                            HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: tr-sender;
                                    width: 60px;
                                    font-size: 13px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> from-address;
                                    placeholder-text: "sender@example.com";
                                    horizontal-stretch: 1;
                                }
                            }

                            // Recipient
                            HorizontalLayout {
                                spacing: 8px;

                                Text {
                                    text: tr-recipient;
                                    width: 60px;
                                    font-size: 13px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                LineEdit {
                                    text <=> to-address;
                                    placeholder-text: tr-recipient-hint;
                                    horizontal-stretch: 1;
                                }
                            }
                        }
                    }

                    // Send Mode Section
                    OutlinedCard {
                        VerticalLayout {
                            padding: 16px;
                            spacing: 10px;

                            SectionHeader { title: tr-send-mode; }

                            // Mode Selection
                            SegmentedButton {
                                items: [
                                    { text: tr-eml-batch },
                                    { text: tr-single-attachment },
                                    { text: tr-dir-attachment },
                                ];
                                current-index: send-mode == SendMode.EmlBatch ? 0 :
                                              (send-mode == SendMode.SingleAttachment ? 1 : 2);
                                index-changed(idx) => {
                                    if idx == 0 {
                                        send-mode = SendMode.EmlBatch;
                                    } else if idx == 1 {
                                        send-mode = SendMode.SingleAttachment;
                                    } else {
                                        send-mode = SendMode.DirAttachment;
                                    }
                                }
                            }

                            // EML Mode Options
                            if send-mode == SendMode.EmlBatch: VerticalLayout {
                                spacing: 8px;

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-eml-directory;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> eml-dir;
                                        horizontal-stretch: 1;
                                    }

                                    Button { text: tr-browse; clicked => { browse-eml-dir(); } }
                                }

                                HorizontalLayout {
                                    spacing: 8px;
                                    alignment: start;

                                    Text {
                                        text: tr-extension;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> eml-extension;
                                        width: 60px;
                                    }

                                    if eml-file-count > 0: Rectangle {
                                        background: MaterialPalette.tertiary_container;
                                        border-radius: 10px;
                                        height: 20px;
                                        width: 80px;

                                        Text {
                                            text: "Found: " + eml-file-count;
                                            font-size: 11px;
                                            color: MaterialPalette.on_tertiary_container;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                            }

                            // Single Attachment Mode
                            if send-mode == SendMode.SingleAttachment: VerticalLayout {
                                spacing: 8px;

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-attachment-file;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> attachment-path;
                                        horizontal-stretch: 1;
                                    }

                                    Button { text: tr-browse; clicked => { browse-attachment(); } }
                                }

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-email-subject;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> subject-template;
                                        horizontal-stretch: 1;
                                    }
                                }

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-email-body;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> text-template;
                                        horizontal-stretch: 1;
                                    }
                                }
                            }

                            // Directory Attachment Mode
                            if send-mode == SendMode.DirAttachment: VerticalLayout {
                                spacing: 8px;

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-attachment-directory;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> attachment-dir;
                                        horizontal-stretch: 1;
                                    }

                                    Button { text: tr-browse; clicked => { browse-attachment-dir(); } }
                                }

                                if attachment-file-count > 0: HorizontalLayout {
                                    alignment: start;

                                    Rectangle {
                                        background: MaterialPalette.tertiary_container;
                                        border-radius: 10px;
                                        height: 20px;
                                        width: 80px;

                                        Text {
                                            text: "Found: " + attachment-file-count;
                                            font-size: 11px;
                                            color: MaterialPalette.on_tertiary_container;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-email-subject;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> subject-template;
                                        horizontal-stretch: 1;
                                    }
                                }

                                HorizontalLayout {
                                    spacing: 8px;

                                    Text {
                                        text: tr-email-body;
                                        width: 60px;
                                        font-size: 13px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }

                                    LineEdit {
                                        text <=> text-template;
                                        horizontal-stretch: 1;
                                    }
                                }
                            }
                        }
                    }

                    // Advanced Options Section
                    OutlinedCard {
                        VerticalLayout {
                            padding: 16px;
                            spacing: 10px;

                            SectionHeader { title: tr-advanced-options; }

                            // Performance row
                            HorizontalLayout {
                                spacing: 12px;
                                alignment: start;

                                HorizontalLayout {
                                    spacing: 4px;
                                    Text {
                                        text: tr-processes;
                                        font-size: 12px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }
                                    LineEdit { text <=> processes; width: 50px; }
                                }

                                HorizontalLayout {
                                    spacing: 4px;
                                    Text {
                                        text: tr-batch-size;
                                        font-size: 12px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }
                                    LineEdit { text <=> batch-size-str; width: 50px; }
                                }

                                HorizontalLayout {
                                    spacing: 4px;
                                    Text {
                                        text: tr-timeout;
                                        font-size: 12px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }
                                    LineEdit { text <=> smtp-timeout-str; width: 50px; }
                                }
                            }

                            // Loop settings
                            HorizontalLayout {
                                spacing: 12px;
                                alignment: start;

                                SwitchRow { label: tr-infinite-loop; checked <=> loop-mode; }

                                HorizontalLayout {
                                    spacing: 4px;
                                    Text {
                                        text: tr-repeat-count;
                                        font-size: 12px;
                                        color: MaterialPalette.on_surface_variant;
                                        vertical-alignment: center;
                                    }
                                    LineEdit {
                                        text <=> repeat-count-str;
                                        width: 50px;
                                        enabled: !loop-mode;
                                    }
                                }
                            }

                            // EML specific options
                            if send-mode == SendMode.EmlBatch: HorizontalLayout {
                                spacing: 12px;
                                alignment: start;

                                SwitchRow { label: tr-keep-headers; checked <=> keep-headers; }
                                SwitchRow { label: tr-modify-headers; checked <=> modify-headers; }
                                SwitchRow { label: tr-anonymize-emails; checked <=> anonymize-emails; }
                            }

                            // Log level
                            HorizontalLayout {
                                spacing: 8px;
                                alignment: start;

                                Text {
                                    text: tr-log-level;
                                    font-size: 12px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }

                                ComboBox {
                                    model: ["error", "warn", "info", "debug", "trace"];
                                    current-index: 2;
                                    width: 80px;
                                    selected(s) => { log-level = s; }
                                }
                            }
                        }
                    }
                }
            }

            // ===== Right Panel - Monitoring =====
            VerticalLayout {
                horizontal-stretch: 1;
                spacing: 12px;

                // Statistics
                OutlinedCard {
                    VerticalLayout {
                        padding: 16px;
                        spacing: 12px;

                        SectionHeader { title: tr-statistics; }

                        // Stats Grid
                        HorizontalLayout {
                            spacing: 8px;

                            StatCard {
                                horizontal-stretch: 1;
                                label: tr-total;
                                value: total-count;
                                accent-color: MaterialPalette.primary;
                            }

                            StatCard {
                                horizontal-stretch: 1;
                                label: tr-success;
                                value: success-count;
                                accent-color: MaterialPalette.tertiary;
                            }

                            StatCard {
                                horizontal-stretch: 1;
                                label: tr-failed;
                                value: fail-count;
                                accent-color: MaterialPalette.error;
                            }

                            StatCard {
                                horizontal-stretch: 1;
                                label: "QPS";
                                value: round(qps * 10) / 10;
                                accent-color: MaterialPalette.secondary;
                            }
                        }

                        // Progress
                        Rectangle {
                            height: 6px;
                            border-radius: 3px;
                            background: MaterialPalette.surface_container_highest;

                            Rectangle {
                                width: parent.width * (total-count > 0 ? (sent-count / total-count) : 0);
                                height: parent.height;
                                border-radius: 3px;
                                background: MaterialPalette.primary;

                                animate width { duration: 300ms; easing: ease-out; }
                            }
                        }

                        // Round/Time info
                        HorizontalLayout {
                            spacing: 16px;
                            alignment: start;

                            HorizontalLayout {
                                spacing: 4px;
                                Text {
                                    text: tr-current-round + ":";
                                    font-size: 12px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }
                                Text {
                                    text: current-round + "/" + total-rounds;
                                    font-size: 12px;
                                    font-weight: 600;
                                    color: MaterialPalette.on_surface;
                                    vertical-alignment: center;
                                }
                            }

                            HorizontalLayout {
                                spacing: 4px;
                                Text {
                                    text: tr-elapsed-time + ":";
                                    font-size: 12px;
                                    color: MaterialPalette.on_surface_variant;
                                    vertical-alignment: center;
                                }
                                Text {
                                    text: elapsed-time;
                                    font-size: 12px;
                                    font-weight: 600;
                                    color: MaterialPalette.on_surface;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                }

                // Logs
                OutlinedCard {
                    vertical-stretch: 1;

                    VerticalLayout {
                        padding: 16px;
                        spacing: 8px;

                        SectionHeader { title: tr-send-log; }

                        ScrollView {
                            vertical-stretch: 1;

                            VerticalLayout {
                                spacing: 4px;
                                alignment: start;

                                for entry in logs: LogItem {
                                    timestamp: entry.timestamp;
                                    level: entry.level;
                                    message: entry.message;
                                }
                            }
                        }

                        HorizontalLayout {
                            spacing: 8px;
                            alignment: start;

                            Button { text: tr-clear; clicked => { clear-logs(); } }
                            Button { text: tr-export-log; clicked => { export-logs(); } }
                        }
                    }
                }
            }
        }

        // ===== Bottom Bar =====
        Rectangle {
            height: 52px;
            background: MaterialPalette.surface_container;
            border-radius: 8px;
            clip: true;

            HorizontalLayout {
                padding-left: 16px;
                padding-right: 16px;
                padding-top: 8px;
                padding-bottom: 8px;
                spacing: 12px;
                alignment: center;

                // Status
                HorizontalLayout {
                    spacing: 8px;
                    alignment: center;

                    Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: status == SendStatus.Idle ? MaterialPalette.outline :
                                   (status == SendStatus.Sending ? MaterialPalette.tertiary :
                                   (status == SendStatus.Completed ? MaterialPalette.primary : MaterialPalette.secondary));
                    }

                    Text {
                        text: status-text;
                        font-size: 12px;
                        font-weight: 500;
                        color: MaterialPalette.on_surface;
                        vertical-alignment: center;
                    }
                }

                // Success/Fail counts
                HorizontalLayout {
                    spacing: 12px;
                    alignment: center;

                    HorizontalLayout {
                        spacing: 4px;
                        alignment: center;
                        Text {
                            text: "‚úì";
                            font-size: 12px;
                            color: MaterialPalette.tertiary;
                            vertical-alignment: center;
                        }
                        Text {
                            text: success-count;
                            font-size: 12px;
                            font-weight: 600;
                            color: MaterialPalette.tertiary;
                            vertical-alignment: center;
                        }
                    }

                    HorizontalLayout {
                        spacing: 4px;
                        alignment: center;
                        Text {
                            text: "‚úó";
                            font-size: 12px;
                            color: MaterialPalette.error;
                            vertical-alignment: center;
                        }
                        Text {
                            text: fail-count;
                            font-size: 12px;
                            font-weight: 600;
                            color: MaterialPalette.error;
                            vertical-alignment: center;
                        }
                    }
                }

                Rectangle { horizontal-stretch: 1; }

                // Action buttons
                HorizontalLayout {
                    spacing: 8px;
                    alignment: center;

                    Button {
                        text: tr-save-config;
                        enabled: status != SendStatus.Sending;
                        clicked => { save-config(); }
                    }

                    Button {
                        text: tr-load-config;
                        enabled: status != SendStatus.Sending;
                        clicked => { load-config(); }
                    }

                    Button {
                        text: tr-test-connection;
                        enabled: status != SendStatus.Sending;
                        clicked => { test-connection(); }
                    }

                    FilledButton {
                        text: status == SendStatus.Sending ? tr-stop-send : tr-start-send;
                        clicked => {
                            if status == SendStatus.Sending {
                                stop-send();
                            } else {
                                start-send();
                            }
                        }
                    }
                }
            }
        }
    }

    // ===== Message Dialog =====
    if show-message-dialog: Rectangle {
        background: MaterialPalette.scrim.with-alpha(50%);
        width: 100%;
        height: 100%;

        TouchArea {
            clicked => { close-message-dialog(); }
        }

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: min(380px, parent.width - 40px);
            height: 180px;
            background: MaterialPalette.surface_container_high;
            border-radius: 16px;

            TouchArea {
                // Prevent click through
            }

            VerticalLayout {
                padding: 20px;
                spacing: 12px;

                // Title
                HorizontalLayout {
                    spacing: 10px;
                    alignment: start;

                    Rectangle {
                        width: 32px;
                        height: 32px;
                        border-radius: 16px;
                        background: message-dialog-is-error ?
                            MaterialPalette.error_container :
                            MaterialPalette.tertiary_container;

                        Text {
                            text: message-dialog-is-error ? "‚ö†" : "‚úì";
                            font-size: 16px;
                            color: message-dialog-is-error ?
                                MaterialPalette.on_error_container :
                                MaterialPalette.on_tertiary_container;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    Text {
                        text: message-dialog-title;
                        font-size: 16px;
                        font-weight: 600;
                        color: message-dialog-is-error ? MaterialPalette.error : MaterialPalette.tertiary;
                        vertical-alignment: center;
                    }
                }

                // Content
                Text {
                    text: message-dialog-content;
                    font-size: 13px;
                    color: MaterialPalette.on_surface;
                    wrap: word-wrap;
                    vertical-stretch: 1;
                }

                // Button
                HorizontalLayout {
                    alignment: end;

                    FilledButton {
                        text: tr-ok;
                        clicked => { close-message-dialog(); }
                    }
                }
            }
        }
    }
}
