name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Linux 构建 (CLI + GUI)
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libfreetype6-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build CLI
        run: cargo build --release -p rsendmail-cli

      - name: Build GUI
        run: cargo build --release -p rsendmail-gui

      - name: Package artifacts
        run: |
          mkdir -p dist
          cp target/release/rsendmail dist/rsendmail-cli-linux-x86_64
          cp target/release/rsendmail-gui dist/rsendmail-gui-linux-x86_64
          chmod +x dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: dist/

  # Windows 构建 (CLI + GUI)
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build CLI
        run: cargo build --release -p rsendmail-cli

      - name: Build GUI
        run: cargo build --release -p rsendmail-gui

      - name: Package artifacts
        run: |
          mkdir dist
          copy target\release\rsendmail.exe dist\rsendmail-cli-windows-x86_64.exe
          copy target\release\rsendmail-gui.exe dist\rsendmail-gui-windows-x86_64.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: dist/

  # macOS 构建 (CLI + GUI) - Intel
  build-macos-intel:
    runs-on: macos-15-intel
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build CLI
        run: cargo build --release -p rsendmail-cli

      - name: Build GUI
        run: cargo build --release -p rsendmail-gui

      - name: Package artifacts
        run: |
          mkdir -p dist
          cp target/release/rsendmail dist/rsendmail-cli-darwin-x86_64
          cp target/release/rsendmail-gui dist/rsendmail-gui-darwin-x86_64
          chmod +x dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-binaries
          path: dist/

  # macOS 构建 (CLI + GUI) - Apple Silicon
  build-macos-arm:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build CLI
        run: cargo build --release -p rsendmail-cli

      - name: Build GUI
        run: cargo build --release -p rsendmail-gui

      - name: Package artifacts
        run: |
          mkdir -p dist
          cp target/release/rsendmail dist/rsendmail-cli-darwin-arm64
          cp target/release/rsendmail-gui dist/rsendmail-gui-darwin-arm64
          chmod +x dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-binaries
          path: dist/

  # 创建 Release 并构建 Docker 镜像
  release:
    needs: [build-linux, build-windows, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: dist/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: dist/

      - name: Download macOS Intel artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-intel-binaries
          path: dist/

      - name: Download macOS ARM artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-arm-binaries
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/rsendmail-cli-linux-x86_64
            dist/rsendmail-gui-linux-x86_64
            dist/rsendmail-cli-windows-x86_64.exe
            dist/rsendmail-gui-windows-x86_64.exe
            dist/rsendmail-cli-darwin-x86_64
            dist/rsendmail-gui-darwin-x86_64
            dist/rsendmail-cli-darwin-arm64
            dist/rsendmail-gui-darwin-arm64
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Docker 构建和推送
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            relaxcloud/rsendmail:${{ steps.version.outputs.VERSION }}
            relaxcloud/rsendmail:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
